version: '2'
services:
    # PostgreSQL database image
    db:
        image: postgres
        restart: always
        volumes:
            - "db_volume:/var/lib/postgresql/data"
        environment:
            - POSTGRES_USER=thebeerarchive
            - POSTGRES_DB=thebeerarchive
        env_file:
            - ./passwords.env # Contains POSTGRES_PASSWORD
        ports:
            - "5432:5432" # todo: remove
    
    # Nginx static web & proxy server
    nginx:
        image: nginx
        restart: always
        links:
            - app
        volumes_from:
            - app
        volumes:
            - "./conf/nginx:/etc/nginx/conf.d:ro"
        ports:
            - "80:80"
            - "443:443"
    
    # The python app. Runs flask
    # todo: move to uwsgi
    app:
        build: ./app
        restart: always
        links:
            - db
        volumes:
            - "./app:/usr/src/app:ro"
        environment:
            - FLASK_APP=app.py
            - FLASK_DEBUG=1
        ports:
            - "5000:5000" # todo: remove
        command: "python -m flask run --host=0.0.0.0"

volumes:
    db_volume:
